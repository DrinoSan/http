//
// Created by becirbeg on 22.10.2022.
//

#include "simpleHttpServer.h"
#include "HttpRequest.h"
#include <cstring>
#include <sys/socket.h>

// get sockaddr, IPv4 or IPv6:
void *get_in_addr(struct sockaddr *sa) {
  if (sa->sa_family == AF_INET) {
    return &(((struct sockaddr_in *)sa)->sin_addr);
  }

  return &(((struct sockaddr_in6 *)sa)->sin6_addr);
}

bool simpleHttpServer::startServer(char buffer[], std::string ipAddr,
                                   int64_t port) {
  // Create a socket (IPv4, TCP)
  int sockfd = socket(AF_INET, SOCK_STREAM, 0);
  if (sockfd == -1) {
    std::cout << "Failed to create socket. errno: " << errno << std::endl;
    exit(EXIT_FAILURE);
  }

  // Listen to port 9999 on any address
  sockaddr_in sockaddr;
  sockaddr.sin_family = AF_INET;
  if (ipAddr != "") {
    inet_pton(AF_INET, ipAddr.c_str(), &(sockaddr.sin_addr));
  } else {
    sockaddr.sin_addr.s_addr = INADDR_ANY;
  }
  sockaddr.sin_port = htons(port); // Hton converts number to network byte order

  if (bind(sockfd, (struct sockaddr *)&sockaddr, sizeof(sockaddr)) < 0) {
    std::cout << "Failed to bind to port " << port << ". errno: " << errno
              << std::endl;
    return false;
  }

  std::cout << "Socket FileDeskriptor: " << sockfd << " " << std::endl;

  // Start listening. Hold at most 10 connection in the queue
  if (listen(sockfd, BACK_LOG) < 0) {
    std::cout << "Failed to listen on socket. errno: " << errno << std::endl;
    exit(EXIT_FAILURE);
  }

  // Grab connection from the queue
  auto addrlen = sizeof(sockaddr);
  struct sockaddr_storage their_addr; // connector's address information

  int newConnectionFD;
  char s[INET6_ADDRSTRLEN];

  while ((newConnectionFD = accept(sockfd, (struct sockaddr *)&sockaddr,
                                   (socklen_t *)&their_addr)) > 0) {
    if (newConnectionFD < 0) {
      std::cout << "Failed to grab connection. errno: " << errno << std::endl;
      exit(EXIT_FAILURE);
    }
    inet_ntop(their_addr.ss_family, get_in_addr((struct sockaddr *)&their_addr),
              s, sizeof s);
    std::cout << "Got Connection from: " << s << std::endl;

    if (fork() == 0) {
      close(sockfd);

      char buffer[300];
      auto bytesRead = recv(newConnectionFD, buffer, 300, 0);
      HttpRequest httpRequest{buffer};
      httpParser.parseRequest(&httpRequest, httpRequest.headers);

      std::cout << "-------> Called Path:: " << httpRequest.httpUri << std::endl;
      std::string resp = "HTTP/1.1 200 OK\r\n"
                         "Server: Hello\r\n"
                         "Content-Length: 13\r\n"
                         "Content-Type: text/plain\r\n"
                         "\r\n"
                         "Hello";

      send(newConnectionFD, resp.c_str(), resp.size(), 0);
      close(newConnectionFD);
      exit(0);
    }
    close(newConnectionFD);
  }

  close(sockfd);
  return true;
}
